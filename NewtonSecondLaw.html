<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰›é “ç¬¬äºŒå®šå¾‹æ¨¡æ“¬å™¨ - å®Œç¾ä¿®æ­£ç‰ˆ</title>
    <style>
        body { margin: 0; display: flex; flex-direction: column; align-items: center; font-family: "Microsoft JhengHei", Arial, sans-serif; background-color: #f9f9f9; }
        h1 { margin: 15px 0; font-size: 24px; color: #333; }

        /* å¤–å±¤å®¹å™¨ï¼šå·¦ä¸€å³äºŒä½ˆå±€ */
        #main-container {
            display: flex;
            width: 95%; 
            max-width: 1200px;
            gap: 20px;
            margin-bottom: 20px;
        }

        /* å·¦å´é¢æ¿ */
        #left-panel {
            flex: 1; 
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* å³å´é¢æ¿ */
        #right-panel {
            flex: 1; 
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        /* Canvas */
        canvas { background-color: #fff; border-radius: 4px; }
        #mechanicsCanvas { border: 2px solid #444; background-color: #f0f0f0; margin-bottom: 15px; }
        
        .graph-container { 
            border: 1px solid #ddd; 
            background-color: white; 
            padding: 10px; 
            border-radius: 5px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .graph-container h2 { font-size: 16px; margin: 0 0 10px 0; color: #555; border-bottom: 2px solid #eee; padding-bottom: 5px; }

        /* æ§åˆ¶é … UI */
        .control-group { margin-bottom: 15px; width: 100%; display: flex; align-items: center; justify-content: space-between; }
        .control-group label { font-weight: bold; margin-right: 10px; }
        input[type=range] { flex: 1; cursor: pointer; }
        
        .info { 
            margin-bottom: 15px; 
            padding: 10px; 
            background: #eef; 
            border-radius: 5px; 
            font-family: monospace; 
            font-size: 14px; 
            width: 100%;
            box-sizing: border-box;
            text-align: center;
        }

        /* Joystick */
        #joystick-container { 
            width: 120px; 
            height: 120px; 
            border: 3px solid #555; 
            border-radius: 50%; 
            position: relative; 
            background: radial-gradient(circle, #ddd 0%, #bbb 100%);
            touch-action: none; /* é˜²æ­¢æ‰‹æ©Ÿæ»‘å‹•é é¢ */
            margin: 10px 0;
            user-select: none;
        }
        
        #joystick-handle { 
            width: 30px; 
            height: 30px; 
            border-radius: 50%; 
            background: radial-gradient(circle, #ff4500 0%, #cc0000 100%); 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            pointer-events: none; 
        }
        
        #joystick-text {
            margin-top: 10px;
            font-size: 12px;
            color: #666;
            text-align: center;
        }

        /* æŒ‰éˆ• */
        #export-btn { 
            margin-top: 20px; 
            padding: 10px 25px; 
            background-color: #2196F3; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 14px;
            transition: background 0.3s;
        }
        #export-btn:hover { background-color: #0b7dda; }

    </style>
</head>
<body>
    <h1>ç‰›é “ç¬¬äºŒå®šå¾‹ï¼š$F_{net} = ma$ å‹•æ…‹æ¨¡æ“¬</h1>
    
    <div id="main-container">
        <div id="left-panel">
            <div id="info" class="info">
                è³ªé‡ $m$: <span id="mass-display">1.0</span> kg | 
                æ‘©æ“¦ä¿‚æ•¸ $\mu$: <span id="friction-display">0.00</span><br>
                æ·¨åŠ› $F_{net}$: <span id="force-display">0.00</span> N | 
                åŠ é€Ÿåº¦ $a$: <span id="accel-display">0.00</span> m/sÂ²<br>
                é€Ÿåº¦ $v$: <span id="vel-display">0.00</span> m/s
            </div>
            
            <div class="control-group">
                <label for="mass-input">è³ªé‡ (kg): </label>
                <input type="range" id="mass-input" min="0.5" max="10" step="0.1" value="1.0">
            </div>
            
            <div class="control-group">
                <label for="friction-input">æ‘©æ“¦ä¿‚æ•¸: </label>
                <input type="range" id="friction-input" min="0" max="1.0" step="0.01" value="0.0">
            </div>

            <canvas id="mechanicsCanvas" width="500" height="150"></canvas>
            
            <div id="joystick-container">
                <div id="joystick-handle"></div>
            </div>
            <div id="joystick-text">æ‹–å‹•æ–æ¡¿æ–½åŠ å¤–åŠ› $F_{ext}$<br>(æ”¾æ‰‹æ­¸é›¶)</div>
            
            <button id="export-btn">ğŸ’¾ ä¸‹è¼‰æ•¸æ“š (.csv)</button>
        </div>

        <div id="right-panel">
            <div class="graph-container">
                <h2>é€Ÿåº¦ - æ™‚é–“ ($v-t$)</h2>
                <canvas id="vtGraph" width="550" height="220"></canvas>
            </div>

            <div class="graph-container">
                <h2>ç´¯ç©ä½ç§» - æ™‚é–“ ($s-t$)</h2>
                <canvas id="stGraph" width="550" height="220"></canvas>
            </div>
        </div>
    </div>

    <script>
        // ================= å…¨å±€è®Šé‡ =================
        const canvas = document.getElementById('mechanicsCanvas');
        const ctx = canvas.getContext('2d');
        const joystickContainer = document.getElementById('joystick-container');
        const joystickHandle = document.getElementById('joystick-handle');
        
        // ç•«å¸ƒå¼•ç”¨
        const vtCtx = document.getElementById('vtGraph').getContext('2d');
        const stCtx = document.getElementById('stGraph').getContext('2d');

        // ç‰©ç†åƒæ•¸
        let mass = 1.0;
        let frictionCoeff = 0.0;
        let F_ext = 0;       // æ–æ¡¿æ–½åŠ çš„åŠ›
        let F_net = 0;       // æ·¨åŠ›
        let acceleration = 0;
        let velocity = 0;
        
        // é¡¯ç¤ºåƒæ•¸
        let displayPos = 250; // ç•«å¸ƒä¸Šçš„ä½ç½® (å¾ªç’°ç”¨)
        let accumulatedPos = 0; // ç‰©ç†ä¸Šçš„çœŸå¯¦ç´¯ç©ä½ç§»
        
        // æ¨¡æ“¬å¸¸æ•¸
        const MAX_FORCE = 50; // æœ€å¤§å¤–åŠ› (N)
        const PIXELS_PER_METER = 20; // 1ç±³ç­‰æ–¼å¤šå°‘åƒç´  (ç”¨æ–¼é¡¯ç¤º)
        
        // æ•¸æ“šè¨˜éŒ„
        let timeData = [];
        let velData = [];
        let posData = []; // è¨˜éŒ„ç´¯ç©ä½ç§»
        let globalTime = 0;

        // ================= åˆå§‹åŒ–è¼¸å…¥ç›£è½ =================
        document.getElementById('mass-input').addEventListener('input', (e) => {
            mass = parseFloat(e.target.value);
            document.getElementById('mass-display').textContent = mass.toFixed(1);
        });

        document.getElementById('friction-input').addEventListener('input', (e) => {
            frictionCoeff = parseFloat(e.target.value);
            document.getElementById('friction-display').textContent = frictionCoeff.toFixed(2);
        });

        document.getElementById('export-btn').addEventListener('click', exportCSV);

        // ================= æ–æ¡¿é‚è¼¯ (ä¿®å¾©ç‰ˆ) =================
        let isDragging = false;
        const jsRect = joystickContainer.getBoundingClientRect();
        const jsCenterX = jsRect.width / 2;
        const maxDragDist = jsRect.width / 2 - 15; // æ¸›å»æ‰‹æŸ„åŠå¾‘

        // é€šç”¨é–‹å§‹æ‹–å‹•
        function startDrag(e) {
            e.preventDefault(); // é˜²æ­¢æ‰‹æ©Ÿæ»¾å‹•
            isDragging = true;
            joystickContainer.style.cursor = 'grabbing';
            updateJoystick(e);
        }

        // é€šç”¨æ‹–å‹•ä¸­
        function moveDrag(e) {
            if (!isDragging) return;
            e.preventDefault();
            updateJoystick(e);
        }

        // é€šç”¨çµæŸæ‹–å‹•
        function stopDrag(e) {
            isDragging = false;
            joystickContainer.style.cursor = 'grab';
            // æ­¸é›¶
            joystickHandle.style.left = '50%';
            joystickHandle.style.transform = 'translate(-50%, -50%)';
            F_ext = 0;
        }

        function updateJoystick(e) {
            // ç²å–è§¸æ§æˆ–æ»‘é¼ åº§æ¨™
            let clientX;
            if (e.touches) {
                clientX = e.touches[0].clientX;
            } else {
                clientX = e.clientX;
            }

            // è¨ˆç®—ç›¸å°æ–¼æ–æ¡¿ä¸­å¿ƒçš„åç§»
            const rect = joystickContainer.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            let deltaX = clientX - centerX;

            // é™åˆ¶ç¯„åœ
            deltaX = Math.max(-maxDragDist, Math.min(deltaX, maxDragDist));

            // æ›´æ–°æ‰‹æŸ„ä½ç½® (CSS left æ˜¯ç™¾åˆ†æ¯”æˆ– pxï¼Œé€™è£¡ç”¨ px æ¯”è¼ƒæº–)
            joystickHandle.style.left = (jsCenterX + deltaX) + 'px';
            
            // è¨ˆç®—å¤–åŠ›
            F_ext = (deltaX / maxDragDist) * MAX_FORCE;
        }

        // ç¶å®šæ–æ¡¿äº‹ä»¶
        joystickContainer.addEventListener('mousedown', startDrag);
        window.addEventListener('mousemove', moveDrag); // ç¶å®šåˆ° window é˜²æ­¢æ‹–å‡ºç¯„åœå¤±æ•ˆ
        window.addEventListener('mouseup', stopDrag);

        joystickContainer.addEventListener('touchstart', startDrag, {passive: false});
        window.addEventListener('touchmove', moveDrag, {passive: false});
        window.addEventListener('touchend', stopDrag);


        // ================= ç‰©ç†æ ¸å¿ƒå¼•æ“ =================
        let lastTime = 0;

        function gameLoop(timestamp) {
            if (!lastTime) lastTime = timestamp;
            let dt = (timestamp - lastTime) / 1000;
            lastTime = timestamp;

            // [é—œéµä¿®å¾©]: é˜²æ­¢åˆ‡æ›åˆ†é æ™‚ dt éå¤§å°è‡´ç‰©ç†çˆ†ç‚¸
            if (dt > 0.1) dt = 0.1;

            updatePhysics(dt);
            drawSimulation();
            recordData(dt);
            
            // ç¹ªè£½åœ–è¡¨
            drawGraph(vtCtx, velData, "v", "m/s", false);
            drawGraph(stCtx, posData, "s", "m", true);

            requestAnimationFrame(gameLoop);
        }

        function updatePhysics(dt) {
            // æ‘©æ“¦åŠ›æ–¹å‘èˆ‡é€Ÿåº¦ç›¸å: F_f = -mu * v (é€™è£¡ç°¡åŒ–ç‚ºèˆ‡é€Ÿåº¦æˆæ­£æ¯”çš„é˜»åŠ›ï¼Œæ¨¡æ“¬ç©ºæ°£é˜»åŠ›/é»æ»¯åŠ›æ•ˆæœ)
            // è‹¥è¦æ¨¡æ“¬æ»‘å‹•æ‘©æ“¦ï¼Œæ‡‰ç‚º -mu * N * sign(v)ã€‚ä½†åœ¨é€™å€‹æ¼”ç¤ºä¸­ï¼Œç·šæ€§é˜»åŠ›åœ–å½¢è¼ƒå¥½ç†è§£çµ‚ç«¯é€Ÿåº¦ã€‚
            let F_f = -frictionCoeff * velocity * 5; // *5 è®“æ•ˆæœæ›´æ˜é¡¯

            F_net = F_ext + F_f;
            acceleration = F_net / mass;

            // æ­æ‹‰ç©åˆ†æ³•
            velocity += acceleration * dt;
            
            // é˜²æ­¢æ¥µå°é€Ÿåº¦æŠ–å‹•
            if (Math.abs(velocity) < 0.01 && Math.abs(F_ext) < 0.1) {
                velocity = 0;
            }

            let deltaS = velocity * dt;
            accumulatedPos += deltaS;
            
            // é¡¯ç¤ºä½ç½®å¾ªç’° (0 ~ 500)
            displayPos += deltaS * PIXELS_PER_METER;
            if (displayPos > 500) displayPos -= 500;
            if (displayPos < 0) displayPos += 500;

            // æ›´æ–° DOM æ•¸å€¼
            document.getElementById('force-display').textContent = F_net.toFixed(2);
            document.getElementById('accel-display').textContent = acceleration.toFixed(2);
            document.getElementById('vel-display').textContent = velocity.toFixed(2);
        }

        function drawSimulation() {
            // æ¸…ç©ºç•«å¸ƒ
            ctx.clearRect(0, 0, 500, 150);

            // åœ°é¢
            ctx.fillStyle = "#ddd";
            ctx.fillRect(0, 74, 500, 2);

            // åˆ»åº¦
            ctx.fillStyle = "#999";
            for(let i=0; i<500; i+=50) {
                ctx.fillRect(i, 70, 1, 10);
            }

            // ç‰©é«”
            let size = 30 + mass * 2; // è³ªé‡è¶Šå¤§é«”ç©è¶Šå¤§
            let yPos = 75 - size;
            ctx.fillStyle = "#2196F3"; // è—è‰²æ–¹å¡Š
            ctx.strokeStyle = "#1565C0";
            ctx.lineWidth = 2;
            ctx.fillRect(displayPos - size/2, yPos, size, size);
            ctx.strokeRect(displayPos - size/2, yPos, size, size);

            // åŠ›ç®­é ­ (å¤–åŠ›) - ç´…è‰²
            if (Math.abs(F_ext) > 0.5) {
                drawArrow(displayPos, yPos + size/2, F_ext * 1.5, "red", "F_ext");
            }
            // æ‘©æ“¦åŠ› - ç¶ è‰²
            let F_f = -frictionCoeff * velocity * 5;
            if (Math.abs(F_f) > 0.5) {
                drawArrow(displayPos, yPos + size + 10, F_f * 1.5, "green", "f");
            }
        }

        function drawArrow(x, y, length, color, label) {
            ctx.beginPath();
            ctx.strokeStyle = color;
            ctx.fillStyle = color;
            ctx.lineWidth = 3;
            ctx.moveTo(x, y);
            ctx.lineTo(x + length, y);
            ctx.stroke();

            // ç®­é ­é ­éƒ¨
            let dir = length > 0 ? 1 : -1;
            ctx.beginPath();
            ctx.moveTo(x + length, y);
            ctx.lineTo(x + length - 5 * dir, y - 5);
            ctx.lineTo(x + length - 5 * dir, y + 5);
            ctx.fill();
            
            // æ¨™ç±¤
            ctx.font = "12px Arial";
            ctx.fillText(label, x + length/2, y - 5);
        }

        // ================= æ•¸æ“šèˆ‡åœ–è¡¨ (é—œéµä¿®å¾©) =================
        function recordData(dt) {
            globalTime += dt;
            // æ¯ 0.05ç§’ è¨˜éŒ„ä¸€æ¬¡ï¼Œé¿å…æ•¸æ“šéå¤š
            if (timeData.length === 0 || globalTime - timeData[timeData.length-1] > 0.05) {
                timeData.push(globalTime);
                velData.push(velocity);
                posData.push(accumulatedPos);

                // ä¿æŒæœ€è¿‘ 20 ç§’æ•¸æ“š
                if (timeData[timeData.length-1] - timeData[0] > 20) {
                    timeData.shift();
                    velData.shift();
                    posData.shift();
                }
            }
        }

        function drawGraph(gCtx, data, label, unit, isPos) {
            let w = gCtx.canvas.width;
            let h = gCtx.canvas.height;
            gCtx.clearRect(0, 0, w, h);

            if (data.length < 2) return;

            // 1. è‡ªå‹•ç¸®æ”¾ Y è»¸
            let maxVal = Math.max(...data.map(Math.abs));
            
            // ç‰¹æ®Šè™•ç†ä½ç§»åœ–ï¼šå› ç‚ºå®ƒä¸æ˜¯ä»¥0ç‚ºä¸­å¿ƒï¼Œè€Œæ˜¯çœ‹ç¯„åœ
            let minD = Math.min(...data);
            let maxD = Math.max(...data);
            let range = maxD - minD;
            
            let scaleY, zeroY;

            if (isPos) {
                // ä½ç§»åœ–ï¼šå‹•æ…‹ç¯„åœ
                if (range < 1) range = 1;
                scaleY = (h - 40) / range; 
                // å°‡æœ€æ–°çš„é»ç½®æ–¼å‚ç›´ä¸­é–“ï¼Œæˆ–è€…è®“æ•´å€‹ç¯„åœå±…ä¸­
                // é€™è£¡é¸æ“‡è®“ (max+min)/2 å±…ä¸­
                let mid = (maxD + minD) / 2;
                zeroY = h/2 + mid * scaleY; // é€™åªæ˜¯ç›¸å°åç§»çš„åƒè€ƒ
            } else {
                // é€Ÿåº¦åœ–ï¼š0 åœ¨ä¸­é–“
                if (maxVal < 1) maxVal = 1; // æœ€å°é¡¯ç¤ºç¯„åœ
                scaleY = (h / 2 - 20) / maxVal;
                zeroY = h / 2;
            }

            // X è»¸ç¸®æ”¾ (å›ºå®šé¡¯ç¤º 20ç§’)
            let timeRange = 20; 
            let scaleX = w / timeRange;
            let now = timeData[timeData.length-1];

            // ç¹ªè£½ç¶²æ ¼é›¶ç·š
            gCtx.strokeStyle = "#ccc";
            gCtx.lineWidth = 1;
            gCtx.beginPath();
            if (isPos) {
                // ä½ç§»åœ–ä¸ç•«0ç·šï¼Œç•«é‚Šæ¡†
            } else {
                gCtx.moveTo(0, zeroY);
                gCtx.lineTo(w, zeroY);
            }
            gCtx.stroke();

            // ç¹ªè£½æ•¸æ“šç·š
            gCtx.strokeStyle = isPos ? "#9C27B0" : "#009688";
            gCtx.lineWidth = 2;
            gCtx.beginPath();

            let started = false;

            for (let i = 0; i < data.length; i++) {
                let t = timeData[i];
                let val = data[i];

                let x = w - (now - t) * scaleX;
                let y;

                if (isPos) {
                    // map minD -> h-20, maxD -> 20
                    y = h - 20 - (val - minD) * scaleY;
                } else {
                    y = zeroY - val * scaleY;
                }

                if (i === 0) {
                    gCtx.moveTo(x, y);
                } else {
                    gCtx.lineTo(x, y);
                }
            }
            gCtx.stroke();

            // é¡¯ç¤ºç•¶å‰æ•¸å€¼æ¨™ç±¤
            gCtx.fillStyle = "#333";
            gCtx.font = "12px Arial";
            gCtx.textAlign = "right";
            gCtx.fillText(`ç•¶å‰: ${data[data.length-1].toFixed(2)} ${unit}`, w - 10, 20);
            
            if (!isPos) {
                gCtx.fillText(`+${maxVal.toFixed(1)}`, w-10, zeroY - maxVal*scaleY);
                gCtx.fillText(`-${maxVal.toFixed(1)}`, w-10, zeroY + maxVal*scaleY);
            } else {
                gCtx.fillText(`Max: ${maxD.toFixed(1)}`, w-10, 35);
                gCtx.fillText(`Min: ${minD.toFixed(1)}`, w-10, h-10);
            }
        }

        // ================= å°å‡º CSV =================
        function exportCSV() {
            let csv = "Time(s),Velocity(m/s),Displacement(m)\n";
            for(let i=0; i<timeData.length; i++) {
                csv += `${timeData[i].toFixed(3)},${velData[i].toFixed(3)},${posData[i].toFixed(3)}\n`;
            }
            
            let blob = new Blob([csv], {type: "text/csv"});
            let url = URL.createObjectURL(blob);
            let a = document.createElement('a');
            a.href = url;
            a.download = "physics_data.csv";
            a.click();
        }

        // å•Ÿå‹•å¾ªç’°
        requestAnimationFrame(gameLoop);

    </script>
</body>
</html>
